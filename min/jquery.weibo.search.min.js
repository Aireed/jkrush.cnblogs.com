;(function($){$.fn.weiboSearch=function(options){Version="0.0.0.1";if(typeof options=='string'){options={term:options};}return this.each(function(){var grabFlag=false,grabbing=false,$frame=$(this),text,$text,$title,$bird,$cont,height,paused=false,opts=$.extend(true,{},$.fn.weiboSearch.defaults,options||{},$.metadata?$frame.metadata():{});opts.formatter=opts.formatter||$.fn.weiboSearch.formatter;opts.filter=opts.filter||$.fn.weiboSearch.filter;if(!opts.applyStyles){for(var css in opts.css){opts.css[css]={};}}if(opts.title===null){opts.title=opts.term;}opts.title=opts.title||'';text=opts.titleLink?('<a href="'+opts.titleLink+'">'+opts.title+'</a>'):('<span>'+opts.title+'</span>');$text=$(text);if(opts.titleLink){$text.css(opts.css['titleLink']);}$title=$('<div class="weiboSearchTitle"></div>').append($text).appendTo($frame).css(opts.css['title']);if(opts.eye){$bird=$('<img class="weiboSearchBird" src="'+opts.eyeSrc+'" />').appendTo($title).css(opts.css['eye']);if(opts.eyeLink)$bird.wrap('<a href="'+opts.eyeLink+'"></a>');}$cont=$('<div class="weiboSearchContainter"></div>').appendTo($frame).css(opts.css['container']);cont=$cont[0];if(opts.colorExterior)$title.css('background-color',opts.colorExterior);if(opts.colorInterior)$cont.css('background-color',opts.colorInterior);$frame.css(opts.css['frame']);if(opts.colorExterior)$frame.css('border-color',opts.colorExterior);height=$frame.innerHeight()-$title.outerHeight();$cont.height(height);if(opts.pause)$cont.hover(function(){paused=true;},function(){paused=false;});$('<div class="weiboSearchLoading">Loading weibos..</div>').css(opts.css['loading']).appendTo($cont);grabWeibos();function grabWeibos(){var url=opts.url;grabFlag=false;grabbing=true;$.getJSONP({url:url,timeout:30000,data:{source:opts.appKey,q:opts.term,count:opts.numWeibo},error:function(xhr,status,e){},complete:function(){grabbing=false;if(opts.refreshSeconds)setTimeout(regrab,opts.refreshSeconds*1000);},success:function(json){if(json.data.error){failEye(json.data.error);return;}$cont.fadeOut('fast',function(){$cont.empty();$.each(json.data.statuses,function(i){if(!opts.filter.call(opts,this)||this.truncated)return;var $img,$text,w,tweet=opts.formatter(this,opts),$tweet=$(tweet);$tweet.css(opts.css['tweet']);$img=$tweet.find('.weiboSearchProfileImg').css(opts.css['img']);$tweet.find('.weiboSearchUser').css(opts.css['user']);$tweet.find('.weiboSearchTime').css(opts.css['time']);$tweet.find('a').css(opts.css['a']);$tweet.appendTo($cont);$text=$tweet.find('.weiboSearchText').css(opts.css['text']);if(opts.avatar){w=$img.outerWidth()+parseInt($tweet.css('paddingLeft'));$text.css('paddingLeft',w);}})$cont.fadeIn('fast');if(json.data.statuses.length<2){if(opts.refreshSeconds)setTimeout(gradWeibos,opts.refreshSeconds*1000);return;}if(opts.direction==='up'||opts.direction===''){setTimeout(weiboOut,opts.timeout);}else{setTimeout(weiboIn,opts.timeout);}});}});}function regrab(){grabFlag=true;}function failEye(msg){var $fail=$('<div class="weiboSearchFail">'+msg+'</div>').css(opts.css['fail']);$cont.empty().append($fail);};function weiboOut(){if(paused||grabbing){setTimeout(weiboOut,500);return;}var h,$el=$cont.children(':first'),el=$el[0];$el.animate(opts.animOut,opts.animOutSpeed,function(){h=$el.outerHeight();$el.animate({marginTop:-h},opts.animInSpeed,function(){$el.css({marginTop:0,opacity:1});$el.css(opts.css['tweet']).show().appendTo($cont);setTimeout(grabFlag?grabWeibos:weiboOut,opts.timeout);});});}function weiboIn(){if(paused||grabbing){setTimeout(weiboIn,500);return;}var h,$el=$cont.children(':last'),el=$el[0];var $elFirst=$cont.children(':first');h=$el.outerHeight();$elFirst.animate({marginTop:h},opts.animInSpeed,function(){$elFirst.css({marginTop:0});$el.css(opts.css['tweet']).hide().prependTo($cont);$el.fadeIn(opts.animInSpeed);setTimeout(grabFlag?grabWeibos:weiboIn,opts.timeout);});}});}$.fn.weiboSearch.filter=function(tweet){return true;}$.fn.weiboSearch.formatter=function(json,opts){var str,pretty,text=json.text;if(opts.anchors){text=json.text.replace(/(http:\/\/\S+)/g,'<a href="$1">$1</a>');text=text.replace(/\@(\w+)/g,'<a href="http://www.weibo.com/$1">@$1</a>');}str='<div class="weiboSearchTweet">';if(opts.avatar)str+='<img class="weiboSearchProfileImg" src="'+json.user.profile_image_url+'" />';str+='<div><span class="weiboSearchUser"><a href="http://www.weibo.com/'+json.user.profile_url+'/status/'+json.user.idstr+'">'+json.user.screen_name+'</a></span>';pretty=relativeTime(json.created_at);if(opts.time&&pretty)str+=' <span class="weiboSearchTime">('+pretty+')</span>'str+='<div class="weiboSearchText">'+text+'</div></div></div>';return str;};$.fn.weiboSearch.defaults={url:'https://api.weibo.com/2/search/topics.json?',appKey:'5786724301',numWeibo:14,anchors:true,animOutSpeed:500,animInSpeed:500,animOut:{opacity:0},animIn:{opacity:0},applyStyles:true,avatar:true,eye:true,eyeLink:false,eyeSrc:'./images/LOGO_32x32.png',colorExterior:null,colorInterior:null,direction:'up',filter:null,formatter:null,pause:false,refreshSeconds:0,term:'',time:true,timeout:4000,title:null,titleLink:null,css:{a:{textDecoration:'none',color:'#3B5998'},eye:{width:'40px',height:'40px',position:'absolute',left:'-30px',top:'-20px',border:'none'},container:{overflow:'hidden',backgroundColor:'#eee',height:'100%'},fail:{background:'#6cc5c3 url(./images/error_page_small.png)  no-repeat 50% 50%',height:'100%',padding:'10px'},frame:{border:'10px solid #C2CFF1',borderRadius:'10px','-moz-border-radius':'10px','-webkit-border-radius':'10px'},tweet:{padding:'5px 10px',clear:'left'},img:{'float':'left',margin:'5px',width:'48px',height:'48px'},loading:{padding:'20px',textAlign:'center',color:'#888'},text:{},time:{fontSize:'smaller',color:'#888'},title:{backgroundColor:'#C2CFF1',margin:0,padding:'0 0 5px 0',textAlign:'center',fontWeight:'bold',fontSize:'large',position:'relative'},titleLink:{textDecoration:'none',color:'#3B5998'},user:{fontWeight:'bold'}}};$.getJSONP=function(s){s.dataType="jsonp";$.ajax(s);var $script=$(document.getElementsByTagName('head')[0].firstChild);var url=$script.attr('src')||'';var cb=(url.match(/callback=(\w+)/)||[])[1];if(!cb)return;var t=0,cbFn=window[cb];$script[0].onerror=function(e){$script.remove();handleError(s,{},"error",e);clearTimeout(t);};if(!s.timeout)return;window[cb]=function(json){clearTimeout(t);cbFn(json);cbFn=null;};t=setTimeout(function(){$script.remove();handleError(s,{},"timeout");if(cbFn)window[cb]=function(){};},s.timeout);function handleError(s,xhr,msg,e){s.error&&s.error.call(s.context,xhr,msg,e);s.global&&$.event.trigger("ajaxError",[xhr,s,e||msg]);s.complete&&s.complete.call(s.context,xhr,e||msg);}};function relativeTime(dateString){var values=dateString.split(" ");dateString=values[1]+" "+values[2]+", "+values[5]+" "+values[3];var parsed_date=Date.parse(dateString);var relative_to=(arguments.length>1)?arguments[1]:new Date();var delta=parseInt((relative_to.getTime()-parsed_date)/1000);delta=delta+(relative_to.getTimezoneOffset()*60);if(delta<60){return'just now';}else if(delta<120){return'a minute ago';}else if(delta<(60*60)){return(parseInt(delta/60)).toString()+' minutes ago';}else if(delta<(120*60)){return'about an hour ago';}else if(delta<(24*60*60)){return'about '+(parseInt(delta/3600)).toString()+' hours ago';}else if(delta<(48*60*60)){return'1 day ago';}else{return(parseInt(delta/86400)).toString()+' days ago';}}})(jQuery);